name: Android Build & Smoke Test

env:
  NODE_OPTIONS: --openssl-legacy-provider
  ADB_INSTALL_TIMEOUT: 20
  SMOKE_SOFT_FAIL: ${{ github.event.inputs.smoke_soft_fail }}
  ANDROID_BUILD_TOOLS: "31.0.0"
  ANDROID_SERIAL: emulator-5554

on:
  workflow_dispatch:
    inputs:
      smoke_soft_fail:
        description: "Mark smoke test neutral on failure (upload logs anyway)"
        required: false
        default: "false"
  push:
    branches:
      - main
      - develop
      - feat/ccpm-framework
  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build APKs
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11 (Gradle)
        id: j11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Java 17 (sdkmanager tools)
        id: j17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Verify Java toolchains
        shell: bash
        run: |
          echo "Gradle should use Java 11:"
          "${{ steps.j11.outputs.path }}/bin/java" -version
          echo "sdkmanager should use Java 17:"
          "${{ steps.j17.outputs.path }}/bin/java" -version


      - name: Bootstrap Android cmdline-tools r8 (8092744)
        shell: bash
        env:
          JAVA_HOME: ${{ steps.j17.outputs.path }}
        run: |
          set -euo pipefail
          # Prepare SDK root
          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT"

          # Download cmdline-tools r8 (8092744) for macOS/Linux
          # macOS and Linux use same archive name pattern; mac runners need 'darwin', ubuntu 'linux'
          OS=$(uname | tr '[:upper:]' '[:lower:]')
          if [[ "$OS" == "darwin" ]]; then
            URL="https://dl.google.com/android/repository/commandlinetools-mac-8092744_latest.zip"
          else
            URL="https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip"
          fi

          curl -fsSL "$URL" -o cmdtools.zip
          unzip -q cmdtools.zip -d cmdline-tools-tmp
          # Move to canonical 'cmdline-tools/r8'
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/r8"
          mv cmdline-tools-tmp/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/r8/"
          rm -rf cmdline-tools-tmp cmdtools.zip

          # Path wiring to ensure we always use r8 sdkmanager
          echo "$ANDROID_SDK_ROOT/cmdline-tools/r8/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          
          # Set local.properties for Gradle
          echo "sdk.dir=$ANDROID_SDK_ROOT" > ${{ github.workspace }}/android/local.properties

      - name: Accept SDK licenses (r8)
        shell: bash
        env:
          JAVA_HOME: ${{ steps.j17.outputs.path }}
        run: |
          set -euo pipefail
          echo "Accepting SDK licenses non-interactively..."
          ( echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y" ) | sdkmanager --licenses || true

      - name: Install platform-tools + build-tools + emulator + platforms (r8)
        shell: bash
        env:
          JAVA_HOME: ${{ steps.j17.outputs.path }}
        run: |
          set -euo pipefail
          sdkmanager --install "platform-tools" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "emulator" \
            "platforms;android-31" \
            "system-images;android-30;default;x86_64"
          # Prove r8 is in effect and apksigner exists at pinned version
          "${ANDROID_SDK_ROOT}/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner" --version

      - name: Print versions
        env:
          JAVA_HOME: ${{ steps.j11.outputs.path }}
        run: |
          echo "JAVA (Gradle):" && java -version
          echo "Gradle wrapper:" && ./android/gradlew -v
          echo "SDK Root: $ANDROID_SDK_ROOT"

      - name: Use Node 18 (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Prime Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Ensure Gradle build cache on
        run: |
          mkdir -p ~/.gradle
          {
            echo "org.gradle.caching=true"
            echo "org.gradle.parallel=false"
          } >> ~/.gradle/gradle.properties
          
      - name: Install Node dependencies
        run: npm install --legacy-peer-deps

      - name: Install TrackPlayer stub (TEMP for CI)
        run: |
          # Create TrackPlayer stub for CI builds
          mkdir -p node_modules/react-native-track-player
          cat > node_modules/react-native-track-player/package.json << 'EOF'
          {
            "name": "react-native-track-player",
            "version": "0.0.0-stub",
            "description": "Temporary stub for react-native-track-player (CI build only)",
            "main": "index.js",
            "private": true
          }
          EOF
          cat > node_modules/react-native-track-player/index.js << 'EOF'
          // TEMP STUB: react-native-track-player disabled for CI build
          const TrackPlayer = {
            setupPlayer: async () => console.log('TrackPlayer stub: setupPlayer called'),
            stop: async () => console.log('TrackPlayer stub: stop called'),
            getTrack: async () => null,
            getState: async () => 'idle',
            getPosition: async () => 0,
            play: async () => {},
            pause: async () => {},
            reset: async () => {},
            add: async () => {},
            skip: async () => {},
            skipToNext: async () => {},
            skipToPrevious: async () => {},
            remove: async () => {},
            destroy: async () => {},
            updateOptions: async () => {},
            updateMetadataForTrack: async () => {},
            getQueue: async () => [],
            getCurrentTrack: async () => null,
            getDuration: async () => 0,
            getBufferedPosition: async () => 0,
            getVolume: async () => 1,
            setVolume: async () => {},
            getRate: async () => 1,
            setRate: async () => {},
            seekTo: async () => {},
            setRepeatMode: async () => {},
            getRepeatMode: async () => 0,
          };
          export default TrackPlayer;
          EOF
          echo "TrackPlayer stub installed for CI build"

      - name: Make Gradle wrapper executable
        run: chmod +x ./android/gradlew

      - name: Build Debug & Release (with build watchdog)
        env:
          JAVA_HOME: ${{ steps.j11.outputs.path }}
          NODE_OPTIONS: --openssl-legacy-provider
          GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.jvmargs='-Xmx3g -XX:+HeapDumpOnOutOfMemoryError' -Dorg.gradle.workers.max=2"
        run: |
          set -e
          cd android
          
          # Build watchdog function with diagnostics
          build_with_watchdog() {
            local task="$1"
            local timeout_min=25
            ./gradlew "$task" --build-cache --no-parallel --stacktrace &
            local gradle_pid=$!
            
            # Monitor build progress
            local elapsed=0
            while kill -0 $gradle_pid 2>/dev/null; do
              sleep 60
              elapsed=$((elapsed + 1))
              echo "📊 Build progress: ${elapsed}min / ${timeout_min}min"
              
              if [ $elapsed -ge $timeout_min ]; then
                echo "❌ Build timeout after ${timeout_min}min - killing Gradle"
                kill -9 $gradle_pid 2>/dev/null || true
                
                # Diagnostic dump
                echo "🔍 Process tree at timeout:"
                pgrep -f gradle | xargs -r ps -fp || true
                echo "🔍 Gradle daemon status:"
                ./gradlew --status || true
                echo "🔍 System load:"
                uptime || true
                
                exit 1
              fi
            done
            
            wait $gradle_pid
            echo "✅ Build completed in ${elapsed}min"
          }
          
          build_with_watchdog ":app:assembleDebug"
          build_with_watchdog ":app:assembleRelease"

      - name: Print artifact sizes
        run: |
          ls -lh android/app/build/outputs/apk/debug/*.apk  || true
          ls -lh android/app/build/outputs/apk/release/*.apk || true

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 14

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 14

      - name: Extract SDK + sizes from manifest/APKs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          echo "${ANDROID_SDK_ROOT}/build-tools/31.0.0" >> "$GITHUB_PATH"
          echo "${ANDROID_SDK_ROOT}/platform-tools" >> "$GITHUB_PATH"

          APK_DEBUG="$(ls -1 android/app/build/outputs/apk/debug/*.apk | head -n1)"
          APK_RELEASE="$(ls -1 android/app/build/outputs/apk/release/*.apk | head -n1)"

          # Use aapt2 if available, else aapt
          AAPT="$(command -v aapt2 || true)"
          [ -z "$AAPT" ] && AAPT="$(command -v aapt || true)"

          # Fallback to apkanalyzer if needed
          if [ -n "$AAPT" ]; then
            MIN_SDK="$($AAPT dump badging "$APK_DEBUG" | sed -n "s/.*sdkVersion:'\([^']*\)'.*/\1/p" | head -n1)"
            TGT_SDK="$($AAPT dump badging "$APK_DEBUG" | sed -n "s/.*targetSdkVersion:'\([^']*\)'.*/\1/p" | head -n1)"
          else
            MIN_SDK="$(apkanalyzer manifest min-sdk "$APK_DEBUG" || true)"
            TGT_SDK="$(apkanalyzer manifest target-sdk "$APK_DEBUG" || true)"
          fi

          DBG_MB="$(( $(stat -c%s "$APK_DEBUG" 2>/dev/null || stat -f%z "$APK_DEBUG") / 1024 / 1024 ))"
          REL_MB="$(( $(stat -c%s "$APK_RELEASE" 2>/dev/null || stat -f%z "$APK_RELEASE") / 1024 / 1024 ))"

          echo "SDK_MIN=$MIN_SDK" >> $GITHUB_ENV
          echo "SDK_TARGET=$TGT_SDK" >> $GITHUB_ENV
          echo "APK_DEBUG_MB=$DBG_MB" >> $GITHUB_ENV
          echo "APK_RELEASE_MB=$REL_MB" >> $GITHUB_ENV

      - name: Ensure build-tools for apksigner/aapt
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          if [ -z "${ANDROID_SDK_ROOT}" ] || [ ! -d "${ANDROID_SDK_ROOT}" ]; then
            echo "❌ ANDROID_SDK_ROOT not set or invalid"; exit 1
          fi

          # Use the build-tools version already installed
          echo "${ANDROID_SDK_ROOT}/build-tools/${{ env.ANDROID_BUILD_TOOLS }}" >> "$GITHUB_PATH"

          "${ANDROID_SDK_ROOT}/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner" version

      - name: Gather APK metadata (debug + release)
        id: apkmeta
        shell: bash
        run: |
          mkdir -p artifacts/meta
          DBG=$(ls android/app/build/outputs/apk/debug/*.apk | head -n1)
          REL=$(ls android/app/build/outputs/apk/release/*.apk | head -n1 || true)

          # Prefer aapt, fallback apkanalyzer
          meta() {
            local APK="$1" ; local OUT="$2"
            if [ -z "$APK" ] || [ ! -f "$APK" ]; then return 0; fi
            if command -v aapt >/dev/null 2>&1; then
              {
                echo "APK=$APK"
                aapt dump badging "$APK"
              } > "$OUT" || true
            elif command -v apkanalyzer >/dev/null 2>&1; then
              {
                echo "APK=$APK"
                apkanalyzer manifest print "$APK"
              } > "$OUT" || true
            fi
          }

          meta "$DBG" artifacts/meta/debug_badging.txt
          meta "$REL" artifacts/meta/release_badging.txt

          # Write outputs for later steps
          echo "debug_apk=$DBG" >> $GITHUB_OUTPUT
          echo "release_apk=$REL" >> $GITHUB_OUTPUT

      - name: Verify Release APK signing
        if: ${{ steps.apkmeta.outputs.release_apk != '' }}
        shell: bash
        run: |
          apksigner verify --print-certs "${{ steps.apkmeta.outputs.release_apk }}"

      - name: APK size guard
        shell: bash
        run: |
          DBG=${{ steps.apkmeta.outputs.debug_apk }}
          REL=${{ steps.apkmeta.outputs.release_apk }}
          mkdir -p artifacts/meta
          summary="$GITHUB_STEP_SUMMARY"

          sz() { [ -f "$1" ] && stat -c%s "$1" || echo 0; }
          DBG_SIZE=$(sz "$DBG")
          REL_SIZE=$(sz "$REL")

          # Thresholds (adjustable)
          DBG_MAX=$((120 * 1024 * 1024))   # 120 MB
          REL_MAX=$((80 * 1024 * 1024))    # 80 MB

          echo "## APK Size" >> "$summary"
          echo "- Debug: $((DBG_SIZE/1024/1024)) MB" >> "$summary"
          if [ -f "$REL" ]; then
            echo "- Release: $((REL_SIZE/1024/1024)) MB" >> "$summary"
          fi

          WARN=0
          if [ "$DBG_SIZE" -gt "$DBG_MAX" ]; then echo "⚠️ Debug APK exceeds ${DBG_MAX} bytes" >> "$summary"; WARN=1; fi
          if [ -f "$REL" ] && [ "$REL_SIZE" -gt "$REL_MAX" ]; then echo "⚠️ Release APK exceeds ${REL_MAX} bytes" >> "$summary"; WARN=1; fi

          # Do not fail build; just warn (flip to hard fail later if desired)
          exit 0

      - name: SDK sanity (min/target)
        shell: bash
        run: |
          summary="$GITHUB_STEP_SUMMARY"
          FILE="artifacts/meta/debug_badging.txt"
          if [ -f "$FILE" ]; then
            MIN=$(grep -Eo "sdkVersion:'.*'|uses-sdk:minSdkVersion:'[0-9]+'" "$FILE" | head -n1 | sed "s/.*'//;s/'//")
            TGT=$(grep -Eo "targetSdkVersion:'[0-9]+'" "$FILE" | head -n1 | sed "s/.*'//;s/'//")
            echo "## SDK" >> "$summary"
            echo "- minSdk: \`${MIN:-unknown}\`" >> "$summary"
            echo "- targetSdk: \`${TGT:-unknown}\`" >> "$summary"
          fi

      - name: Upload metadata artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: artifacts/meta/**
          retention-days: 14

      - name: Publish run identifiers
        if: always()
        shell: bash
        run: |
          echo "${GITHUB_RUN_ID}" > RUN_ID.txt
          echo "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" > RUN_URL.txt

      - name: Upload run identifiers
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ids
          path: |
            RUN_ID.txt
            RUN_URL.txt

  smoke-test:
    name: Android Smoke Test (Ubuntu fallback, accel off)
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 35
    env:
      NODE_OPTIONS: --openssl-legacy-provider
      ADB_INSTALL_TIMEOUT: 20
      ANDROID_SERIAL: emulator-5554
    steps:
      - uses: actions/checkout@v4

      - name: Bootstrap Android cmdline-tools r8 (8092744)
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT"
          URL="https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip"
          curl -fsSL "$URL" -o cmdtools.zip
          unzip -q cmdtools.zip -d cmdline-tools-tmp
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/r8"
          mv cmdline-tools-tmp/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/r8/"
          rm -rf cmdline-tools-tmp cmdtools.zip
          echo "$ANDROID_SDK_ROOT/cmdline-tools/r8/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/emulator" >> "$GITHUB_PATH"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"

      - name: Accept SDK licenses (r8)
        shell: bash
        run: |
          set -euo pipefail
          echo "Accepting SDK licenses non-interactively..."
          ( echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y"; echo "y" ) | sdkmanager --licenses || true

      - name: Install SDK components
        shell: bash
        run: |
          set -euo pipefail
          sdkmanager --install "platform-tools" "emulator" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platforms;android-31" \
            "system-images;android-30;default;x86_64"
          "${ANDROID_SDK_ROOT}/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner" -version

      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: artifacts/debug

      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: artifacts/release

      - name: Create AVD (API 30 default x86_64)
        shell: bash
        run: |
          set -euo pipefail
          echo "no" | avdmanager create avd -n ci_api_30 -k "system-images;android-30;default;x86_64" --device "pixel_5"

      - name: Boot emulator (accel off, pinned serial + watchdog)
        shell: bash
        env:
          ANDROID_SERIAL: emulator-5554
        run: |
          set -euo pipefail
          mkdir -p artifacts/smoke-logs artifacts/ids artifacts/summary
          adb kill-server || true
          emulator -avd ci_api_30 -port 5554 \
            -no-snapshot -no-snapshot-save -no-window -no-audio -no-boot-anim \
            -gpu swiftshader_indirect -camera-back none -netfast -no-metrics \
            -accel off -wipe-data -qemu -m 1024 \
            -verbose > artifacts/smoke-logs/emulator.txt 2>&1 &
          EMU_PID=$!

          boot_deadline=$((SECONDS+540))
          ( sleep 900; echo "[WATCHDOG] Ubuntu emulator boot exceeded 900s; adb devices:"; adb devices -l || true; kill -9 $EMU_PID || true; echo "BOOT_FAILED=1" >> $GITHUB_ENV; ) &
          BOOT_WD=$!

          adb start-server
          adb -s "$ANDROID_SERIAL" wait-for-device || true
          while [ $SECONDS -lt $boot_deadline ]; do
            st=$(adb -s "$ANDROID_SERIAL" get-state 2>/dev/null | tr -d '\r')
            booted=$(adb -s "$ANDROID_SERIAL" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            [ "$st" = "device" ] && [ "$booted" = "1" ] && break
            sleep 5
          done

          if [ "${booted:-0}" != "1" ]; then
            echo "boot_ok=false" > artifacts/summary/summary.env
            echo "BOOT_FAILED=1" >> $GITHUB_ENV
          else
            echo "boot_ok=true" > artifacts/summary/summary.env
            echo "BOOT_FAILED=0" >> $GITHUB_ENV
            kill $BOOT_WD || true
            adb -s "$ANDROID_SERIAL" shell settings put global window_animation_scale 0 || true
            adb -s "$ANDROID_SERIAL" shell settings put global transition_animation_scale 0 || true
            adb -s "$ANDROID_SERIAL" shell settings put global animator_duration_scale 0 || true
          fi
      
      - name: Install + Launch (minimal smoke)
        if: env.BOOT_FAILED == '0'
        shell: bash
        run: |
          set -euo pipefail
          AAPT="${ANDROID_SDK_ROOT}/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/aapt"
          APP_ID=$($AAPT dump badging artifacts/debug/app-debug.apk | awk -F"'" '/package: name=/{print $2}')
          adb -s "$ANDROID_SERIAL" install -r "artifacts/debug/app-debug.apk"
          adb -s "$ANDROID_SERIAL" logcat -c || true
          adb -s "$ANDROID_SERIAL" logcat -v time > artifacts/smoke-logs/logcat.txt 2>&1 &
          LOG_PID=$!
          adb -s "$ANDROID_SERIAL" shell monkey -p "$APP_ID" -c android.intent.category.LAUNCHER 1

          start_ts=$SECONDS; deadline=$((SECONDS+120)); ttjs_s=""
          while [ $SECONDS -lt $deadline ]; do
            if grep -q "ReactNativeJS: Running" artifacts/smoke-logs/logcat.txt; then
              ttjs_s=$((SECONDS-start_ts)); break
            fi
            sleep 1
          done
          kill $LOG_PID || true
          echo "ttjs_s=${ttjs_s:-}" >> artifacts/summary/summary.env

      - name: Build summary.json & Upload artifacts
        shell: bash
        run: |
          set -euo pipefail
          SHA_SHORT=$(git rev-parse --short HEAD)
          DEBUG_SIZE=$( [ -f artifacts/debug/app-debug.apk ] && stat -c%s artifacts/debug/app-debug.apk || echo "0" )
          RELEASE_SIZE=$( [ -f artifacts/release/app-release.apk ] && stat -c%s artifacts/release/app-release.apk || echo "0" )
          source artifacts/summary/summary.env || true
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          cat > artifacts/summary/summary.json <<JSON
          {"commit":"$SHA_SHORT","boot_ok":${boot_ok:-false},"ttjs_s":${ttjs_s:-null},"debug_apk_bytes":$DEBUG_SIZE,"release_apk_bytes":$RELEASE_SIZE,"run_id":"$GITHUB_RUN_ID","run_url":"$RUN_URL"}
          JSON
      - uses: actions/upload-artifact@v4
        with: { name: smoke-logs, path: artifacts/smoke-logs/ }
      - uses: actions/upload-artifact@v4
        with: { name: ids, path: artifacts/ids/ }
      - uses: actions/upload-artifact@v4
        with: { name: summary, path: artifacts/summary/summary.json }


